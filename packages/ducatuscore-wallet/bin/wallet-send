#!/usr/bin/env node

var program = require('commander');
var utils = require('./cli-utils');
var _ = require('lodash');
var dwc = require('@ducatus/ducatuscore-wallet-client');
var Ducatuscore_ = {
  bch: dwc.DucatuscoreCash,
  btc: dwc.Ducatuscore,
  duc: dwc.DucatuscoreDuc,
};  

program = utils.configureCommander(program);

program
  .option('--fee <fee-policy>', 'Fee policy to use (default "normal") [urgent, priority/normal/economy/superEconomy] ')
  .usage('[options] <address> <amount> [note]')
  .description('Create a proposal for sending bitcoins to a destination address.\n  The amount can be specified in bit, btc or sat (the default).');

program.on('--help', function() {
  console.log('  Examples:');
  console.log('');
  console.log('    $ wallet-send n2HRFgtoihgAhx1qAEXcdBMjoMvAx7AcDc 500bit');
  console.log('    $ wallet-send mgWeRvUC6d1LRPKtdDbvYEpaUEmApS4XrY 0.2btc "dinner with friends"');
  console.log('');
});
program.parse(process.argv);

var args = program.args;
if (!args[0])
  program.help();


function confirmDiag(amountStr, note, cb) {
  const readline = require('readline');

  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  rl.question(`Confirm send ${amountStr} to ${note}? (y/N)`, (answer) => {
    rl.close();
    return cb(answer =='y');
  });
};


function send(client, address, amount, fee, note, uri) { 
  var amount;

  fee = fee || 'normal';
  client.createTxProposal({
    outputs: [{
      toAddress: address,
      amount: amount,
    }],
    message: note,
    feeLevel: fee,
  }, function(err, txp) {
    utils.die(err);
    client.publishTxProposal({
      txp: txp
    }, function(err) {
      utils.die(err);
      console.log(' * Tx created: ID %s [%s] RequiredSignatures:',
        utils.shortID(txp.id), txp.status, txp.requiredSignatures);
    });
  });
};


var arg1 = args[0];
var uri;



utils.getClient(program, {
  mustExist: true
}, function(client) {
  var coin = client.credentials.coin;
  var ducatuscore = Ducatuscore_[coin];

  var uri, addr, amount, note;

  // no backwards compat uri
  if ((/^bitcoin(cash)?:\?r=[\w+]/).exec(arg1)) {
    var coin2 = 'btc';
    if (arg1.indexOf('bitcoincash') === 0) coin2 = 'bch';
    if (coin != coin2) utils.die('Wallet / Payment Coin mismatch');
    uri  = arg1.replace(/bitcoin(cash)?:\?r=/, '');

  } else {

    // BIP21
    try { 

      var parsed = new ducatuscore.URI(arg1);
      if (!parsed.r) {

        addr = parsed.address ? parsed.address.toString() : '';
        note = parsed.message;
        amount = parsed.amount ? parsed.amount : '';

      } else {
        uri = parsed.r;
      }
    } catch (e) {
      uri = null;
    }
  }

  // Grab data from CLI if not set before
  addr = addr || arg1;
  amount = amount || utils.parseAmount(args[1]);
  note = note ||  args[2];

  send(client, addr, amount, program.fee, note);
});
